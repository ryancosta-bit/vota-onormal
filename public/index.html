<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Votação Multiplayer</title>
  <style>
    body {
      margin:0;
      font-family:sans-serif;
      background:#110011;
      color:white;
      text-align:center;
      overflow:hidden;
      user-select:none;
    }

    #painelMestre {
      background:rgba(60,0,60,0.7);
      padding:10px;
      border-bottom:2px solid #800080;
      display:none;
    }

    #jogo {
      display:flex;
      height:90vh;
      flex-direction:column;
      gap:5px;
      padding:10px;
    }

    .quadrado {
      flex:1;
      position:relative;
      border:2px solid #800080;
      overflow:hidden;
      border-radius:10px;
      cursor:pointer;
    }

    .opcaoTitulo {
      position:absolute;
      top:5px;
      left:50%;
      transform:translateX(-50%);
      font-size:1.5rem;
      text-shadow:0 0 5px #a020f0;
    }

    .contador {
      position:absolute;
      top:5px;
      right:10px;
      font-size:1.2rem;
      color:#ffd700;
      text-shadow:0 0 3px black;
    }

    .bola {
      position:absolute;
      width:40px;
      height:40px;
      border-radius:50%;
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:12px;
      color:white;
      text-shadow:0 0 3px black;
    }

    button {
      padding:5px 10px;
      margin:5px;
      border:none;
      border-radius:5px;
      background:#8000ff;
      color:white;
      cursor:pointer;
    }

    button:hover { background:#a020f0; }
  </style>
</head>
<body>
  <div id="painelMestre">
    <h2>Painel do Mestre</h2>
    <input id="opcao1" placeholder="Escolha 1">
    <input id="opcao2" placeholder="Escolha 2">
    <input id="tempo" type="number" placeholder="Tempo (segundos)">
    <button id="iniciar">Iniciar Votação</button>
    <button id="limpar">Limpar Seleções</button>
  </div>

  <div id="jogo">
    <div id="cima" class="quadrado">
      <div class="opcaoTitulo" id="tituloCima">Opção 1</div>
      <div class="contador" id="contadorCima">0</div>
    </div>
    <div id="baixo" class="quadrado">
      <div class="opcaoTitulo" id="tituloBaixo">Opção 2</div>
      <div class="contador" id="contadorBaixo">0</div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const nick = prompt("Digite seu nick (use 'Mestre' para o painel):");
    const isMestre = nick.toLowerCase() === "mestre";

    const painelMestre = document.getElementById("painelMestre");
    const cima = document.getElementById("cima");
    const baixo = document.getElementById("baixo");
    const tituloCima = document.getElementById("tituloCima");
    const tituloBaixo = document.getElementById("tituloBaixo");
    const contadorCima = document.getElementById("contadorCima");
    const contadorBaixo = document.getElementById("contadorBaixo");

    socket.emit("registrar", nick);

    if (isMestre) painelMestre.style.display = "block";

    let jogadores = {};

    socket.on("jogadores", (dados) => {
      jogadores = dados;
      renderBolas();
      atualizarContadores();
    });

    socket.on("iniciarVotacao", (data) => {
      tituloCima.textContent = data.opcoes[0];
      tituloBaixo.textContent = data.opcoes[1];
      atualizarContadores();
    });

    // Mestre buttons
    document.getElementById("iniciar")?.addEventListener("click", () => {
      const op1 = document.getElementById("opcao1").value || "Opção 1";
      const op2 = document.getElementById("opcao2").value || "Opção 2";
      const tempo = parseInt(document.getElementById("tempo").value) || 60;
      socket.emit("novaVotacao", {opcoes:[op1,op2],tempo});
    });

    document.getElementById("limpar")?.addEventListener("click", () => {
      socket.emit("limparSelecoes");
    });

    // Mestre atualiza opções em tempo real
    if(isMestre){
      document.getElementById("opcao1").addEventListener("input", e=>{
        const texto = e.target.value || "Opção 1";
        tituloCima.textContent = texto;
        socket.emit("atualizarTexto", {opcao:"cima", texto});
      });
      document.getElementById("opcao2").addEventListener("input", e=>{
        const texto = e.target.value || "Opção 2";
        tituloBaixo.textContent = texto;
        socket.emit("atualizarTexto", {opcao:"baixo", texto});
      });
    }

    socket.on("atualizarTexto", data=>{
      if(data.opcao==="cima") tituloCima.textContent = data.texto;
      if(data.opcao==="baixo") tituloBaixo.textContent = data.texto;
    });

    // Jogador clica na área para escolher
    cima.addEventListener("click", () => { if(!isMestre) socket.emit("atualizarEscolha", "cima"); });
    baixo.addEventListener("click", () => { if(!isMestre) socket.emit("atualizarEscolha", "baixo"); });

    function atualizarContadores(){
      let countCima = 0, countBaixo = 0;
      for(const j of Object.values(jogadores)){
        if(j.nick.toLowerCase() === "mestre") continue;
        if(j.escolha==="cima") countCima++;
        if(j.escolha==="baixo") countBaixo++;
      }
      contadorCima.textContent = countCima;
      contadorBaixo.textContent = countBaixo;
    }

    function renderBolas() {
      [cima, baixo].forEach(e => e.querySelectorAll(".bola").forEach(b => b.remove()));
      for (const [id, j] of Object.entries(jogadores)) {
        if(j.nick.toLowerCase() === "mestre") continue;
        const area = j.escolha === "baixo" ? baixo : cima;
        const bola = document.createElement("div");
        bola.className = "bola";
        bola.style.background = j.cor;
        bola.textContent = j.nick;
        bola.dataset.id = id;
        area.appendChild(bola);
        if(!j.x) j.x = Math.random()*(area.clientWidth-40);
        if(!j.y) j.y = Math.random()*(area.clientHeight-40);
        bola.style.left = j.x + "px";
        bola.style.top = j.y + "px";
      }
    }

    function animar() {
      for (const [id, j] of Object.entries(jogadores)) {
        if(j.nick.toLowerCase() === "mestre") continue;
        const bola = document.querySelector(`.bola[data-id='${id}']`);
        if(!bola) continue;

        j.vx = j.vx ?? (Math.random()*2-1)*2;
        j.vy = j.vy ?? (Math.random()*2-1)*2;

        j.x += j.vx;
        j.y += j.vy;

        const area = j.escolha==="baixo"?baixo:cima;
        const maxX = area.clientWidth-40;
        const maxY = area.clientHeight-40;

        if(j.x<0 || j.x>maxX) j.vx*=-1;
        if(j.y<0 || j.y>maxY) j.vy*=-1;

        for(const [id2,j2] of Object.entries(jogadores)){
          if(id===id2 || j2.nick.toLowerCase()==="mestre") continue;
          const dx=j.x-j2.x, dy=j.y-j2.y;
          const dist=Math.sqrt(dx*dx+dy*dy);
          if(dist<40){ j.vx*=-1; j.vy*=-1; }
        }

        bola.style.left = j.x+"px";
        bola.style.top = j.y+"px";
      }
      requestAnimationFrame(animar);
    }

    animar();
  </script>
</body>
</html>

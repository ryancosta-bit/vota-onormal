<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Votação Paranormal</title>
<style>
  body {
    background-color: #110011;
    color: white;
    font-family: 'Poppins', sans-serif;
    text-align: center;
    margin: 0;
    overflow: hidden;
    user-select: none;
  }

  .hidden { display: none; }

  #painelMestre {
    background-color: rgba(60, 0, 60, 0.7);
    padding: 10px;
    border-bottom: 2px solid #800080;
  }

  #jogo {
    display: flex;
    flex-direction: column;
    height: 90vh;
    position: relative;
    gap: 10px;
    padding: 10px;
  }

  .quadrado {
    flex: 1;
    border: 2px solid #800080;
    position: relative;
    overflow: hidden;
    transition: background 0.3s ease;
    border-radius: 15px;
  }

  .quadrado:hover {
    background: rgba(128, 0, 128, 0.1);
  }

  .bolinha {
    position: absolute;
    border-radius: 50%;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
  }

  #timer {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 3rem;
    color: #e5c9ff;
    text-shadow: 0 0 15px #a020f0;
    display: none;
    z-index: 5;
  }

  input, button {
    margin: 4px;
    padding: 6px;
    border-radius: 5px;
    border: none;
    outline: none;
  }

  input {
    background: #2b0040;
    color: white;
  }

  button {
    background: #8000ff;
    color: white;
    cursor: pointer;
    transition: 0.3s;
  }

  button:hover {
    background: #a020f0;
  }
</style>
</head>
<body>
<div id="painelMestre" class="hidden">
  <h2>Painel do Mestre</h2>
  <input id="opcao1" placeholder="Opção 1" />
  <input id="opcao2" placeholder="Opção 2" />
  <input id="tempo" type="number" placeholder="Tempo (segundos)" />
  <button id="iniciar">Iniciar Votação</button>
</div>

<div id="jogo">
  <div id="cima" class="quadrado"><h2 id="tituloCima"></h2></div>
  <div id="baixo" class="quadrado"><h2 id="tituloBaixo"></h2></div>
  <div id="timer">10</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const nick = prompt("Digite seu nick (use 'Mestre' para o painel):");
const isMestre = nick.toLowerCase() === "mestre";
socket.emit("registrar", nick);

const cima = document.getElementById("cima");
const baixo = document.getElementById("baixo");
const painelMestre = document.getElementById("painelMestre");
const timerDiv = document.getElementById("timer");
const tituloCima = document.getElementById("tituloCima");
const tituloBaixo = document.getElementById("tituloBaixo");

if (isMestre) {
  painelMestre.classList.remove("hidden");
}

// Armazena as bolinhas dos jogadores
let jogadores = {};

// Atualiza a lista de jogadores e renderiza bolinhas
socket.on("jogadores", (dados) => {
  jogadores = dados;
  renderBolinhas();
});

function renderBolinhas() {
  document.querySelectorAll(".bolinha").forEach(b => b.remove());

  for (const [id, j] of Object.entries(jogadores)) {
    if (j.nick.toLowerCase() === "mestre") continue;

    // Cria bolinha
    const bolinha = document.createElement("div");
    bolinha.className = "bolinha";
    bolinha.style.background = j.cor || "#"+Math.floor(Math.random()*16777215).toString(16);
    bolinha.textContent = j.nick;
    bolinha.style.width = "60px";
    bolinha.style.height = "60px";

    // Define posição inicial aleatória dentro da área
    const area = j.voto === "baixo" ? baixo : cima;
    const maxX = area.clientWidth - 60;
    const maxY = area.clientHeight - 60;
    bolinha.x = j.x ?? Math.random()*maxX;
    bolinha.y = j.y ?? Math.random()*maxY;
    bolinha.vx = j.vx ?? (Math.random()*4-2);
    bolinha.vy = j.vy ?? (Math.random()*4-2);

    bolinha.style.left = bolinha.x + "px";
    bolinha.style.top = bolinha.y + "px";
    area.appendChild(bolinha);
  }
}

// Timer
socket.on("iniciarVotacao", (opcoes) => {
  tituloCima.textContent = opcoes[0];
  tituloBaixo.textContent = opcoes[1];
  startTimer(document.getElementById("tempo")?.value || 10);
});

socket.on("resultado", (resultado) => {
  alert("Resultado: " + resultado);
  timerDiv.style.display = "none";
});

function startTimer(segundos) {
  let tempo = segundos;
  timerDiv.style.display = "block";
  timerDiv.textContent = tempo;
  const interval = setInterval(() => {
    tempo--;
    timerDiv.textContent = tempo;
    if (tempo <= 0) {
      clearInterval(interval);
      timerDiv.style.display = "none";
    }
  }, 1000);
}

// Clique nas áreas para votar
function votar(area) {
  if (isMestre) return;
  socket.emit("votar", area.id);
}

cima.addEventListener("click", () => votar(cima));
baixo.addEventListener("click", () => votar(baixo));

// Movimento das bolinhas com colisão
function animarBolinhas() {
  document.querySelectorAll(".bolinha").forEach(b => {
    const area = b.parentElement;
    const maxX = area.clientWidth - parseInt(b.style.width);
    const maxY = area.clientHeight - parseInt(b.style.height);

    b.x += b.vx;
    b.y += b.vy;

    // Colisão com paredes
    if (b.x < 0 || b.x > maxX) b.vx *= -1;
    if (b.y < 0 || b.y > maxY) b.vy *= -1;

    // Colisão entre bolinhas
    document.querySelectorAll(".bolinha").forEach(o => {
      if (o === b) return;
      const dx = b.x - o.x;
      const dy = b.y - o.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < 60) { // diametro da bolinha
        // simples troca de direção
        b.vx *= -1;
        b.vy *= -1;
        o.vx *= -1;
        o.vy *= -1;
      }
    });

    b.style.left = b.x + "px";
    b.style.top = b.y + "px";
  });

  requestAnimationFrame(animarBolinhas);
}

requestAnimationFrame(animarBolinhas);

// Mestre: prévia e início
document.getElementById("opcao1")?.addEventListener("input", (e) => tituloCima.textContent = e.target.value);
document.getElementById("opcao2")?.addEventListener("input", (e) => tituloBaixo.textContent = e.target.value);
document.getElementById("iniciar")?.addEventListener("click", () => {
  const op1 = document.getElementById("opcao1").value;
  const op2 = document.getElementById("opcao2").value;
  const tempo = parseInt(document.getElementById("tempo").value);
  socket.emit("novaVotacao", { opcoes: [op1, op2], tempo });
});
</script>
</body>
</html>
